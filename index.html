import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  Camera, Plus, History, X, Calendar, Loader2, Save, Mic, MicOff, Wallet, Database, Settings, Bell, LayoutGrid, ChevronLeft, CheckCircle2, RotateCcw, AlertCircle, Square, Sparkles, TrendingUp, PieChart, RefreshCw, AudioLines, Grid, Info, PlusCircle, Globe, Waves
} from 'lucide-react';

/**
 * å¸¥å˜çš„å¸³å‹™è¨˜äº‹æœ¬ v2.0 æ­£å¼ç‰ˆ
 * åŠŸèƒ½ï¼š
 * 1. AI èªéŸ³/æ‹ç…§é›™æ¨¡è­˜åˆ¥
 * 2. é»æ“Šã€Œç¹¼çºŒä¸‹ä¸€ç­†ã€è‡ªå‹•é‡å•Ÿä¸Šæ¬¡è¼¸å…¥æ¨¡å¼ï¼ˆèªéŸ³æˆ–æ‹ç…§ï¼‰
 * 3. é›²ç«¯åŒæ­¥è‡³ Google Sheets
 */

const CATEGORIES = ['é£Ÿç‰©', 'ç”Ÿæ´»', 'å¨›æ¨‚', 'äº¤é€š', 'é†«ç™‚', 'æ•™è‚²', 'å…¶ä»–'];
const CURRENCIES = ['PHP', 'TWD', 'USD', 'HKD', 'JPY'];
const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyPmJnep8GKhqIpwkJgokekQpirRJFZRB-PRXD9QZVpx786tEVDxCOYi4bb7gsj5lyL/exec";

const App = () => {
  const [view, setView] = useState('dashboard');
  const [showDrawer, setShowDrawer] = useState(false);
  const [subMode, setSubMode] = useState(''); 
  const [lastInputMode, setLastInputMode] = useState('manual'); // ç´€éŒ„æœ€å¾Œè¼¸å…¥æ¨¡å¼: manual, voice, camera
  const [expenses, setExpenses] = useState([]);
  const [loading, setLoading] = useState(false);
  const [syncing, setSyncing] = useState(false);
  const [isListening, setIsListening] = useState(false);
  const [statusMsg, setStatusMsg] = useState('');
  const [showConfirmModal, setShowConfirmModal] = useState(false);
  
  const recognitionRef = useRef(null);
  const fileInputRef = useRef(null);
  const apiKey = ""; // API Key ç•™ç©ºï¼Œç³»çµ±è‡ªå‹•æ³¨å…¥

  const getTodayStr = () => new Date().toLocaleDateString('en-CA');

  const initialFormState = {
    date: getTodayStr(),
    amount: '', 
    category: 'é£Ÿç‰©', 
    merchant: '', 
    details: '', 
    currency: 'PHP',
    method: 'ç¾é‡‘'
  };

  const [formData, setFormData] = useState(initialFormState);

  useEffect(() => {
    loadLocalData();
    initSpeechRecognition();
  }, []);

  const loadLocalData = () => {
    const saved = localStorage.getItem('expenses_v3_data');
    if (saved) {
      const parsed = JSON.parse(saved);
      setExpenses(parsed);
      return parsed;
    }
    return [];
  };

  const initSpeechRecognition = () => {
    const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (Recognition) {
      const rec = new Recognition();
      rec.lang = 'zh-TW';
      rec.continuous = false;
      rec.interimResults = false;
      
      rec.onstart = () => {
        setIsListening(true);
        setStatusMsg('ğŸ¤ æ­£åœ¨è†è½æ‚¨çš„æŒ‡ä»¤...');
      };
      
      rec.onend = () => {
        setIsListening(false);
        setStatusMsg(prev => prev.includes('è†è½') ? '' : prev);
      };
      
      rec.onresult = (e) => {
        const transcript = e.results[0][0].transcript;
        callGeminiAI(transcript, 'text');
      };
      
      rec.onerror = (e) => {
        console.error("Speech Error:", e);
        setStatusMsg('âŒ èªéŸ³å•Ÿå‹•å¤±æ•—');
        setIsListening(false);
      };
      
      recognitionRef.current = rec;
    }
  };

  const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
    try {
      const response = await fetch(url, options);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return await response.json();
    } catch (error) {
      if (retries > 0) {
        await new Promise(resolve => setTimeout(resolve, backoff));
        return fetchWithRetry(url, options, retries - 1, backoff * 2);
      }
      throw error;
    }
  };

  const callGeminiAI = async (input, type = 'text') => {
    setLoading(true);
    setStatusMsg('ğŸ¤– AI æ­£åœ¨æ™ºèƒ½è­˜åˆ¥...');
    const today = getTodayStr();
    
    const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­è¨˜å¸³åŠ©æ‰‹ã€‚ä»Šå¤©æ˜¯ ${today}ã€‚è«‹å¾è¼¸å…¥ä¸­æå–è³‡è¨Šä¸¦ä»¥ JSON å›å‚³ã€‚
    æ³¨æ„ï¼š
    1. "amount" å¿…é ˆæ˜¯ç´”æ•¸å­—ã€‚
    2. "currency" é»˜èª "PHP"ã€‚
    3. å•†å®¶åç¨±å¿…é ˆæå–æº–ç¢ºã€‚
    æ ¼å¼ï¼š{"amount": æ•¸å­—, "merchant": "å•†å®¶å", "category": "é£Ÿç‰©/ç”Ÿæ´»/å¨›æ¨‚/äº¤é€š/é†«ç™‚/æ•™è‚²/å…¶ä»–", "details": "ç´°ç¯€èªªæ˜", "date": "YYYY-MM-DD", "currency": "PHP"}`;
    
    try {
      let body = type === 'text' 
        ? { contents: [{ parts: [{ text: `${systemPrompt}\n\nè¼¸å…¥å…§å®¹ï¼šã€Œ${input}ã€` }] }] }
        : { contents: [{ parts: [{ text: systemPrompt }, { inlineData: { mimeType: input.mimeType, data: input.base64 } }] }] };
      
      const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      
      const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "";
      const jsonMatch = text.match(/\{.*\}/s);
      
      if (jsonMatch) {
        const parsed = JSON.parse(jsonMatch[0]);
        
        if (!parsed.amount && type === 'text') {
            const numMatch = input.match(/\d+/);
            if (numMatch) parsed.amount = Number(numMatch[0]);
        }

        const updatedData = { ...formData, ...parsed, currency: parsed.currency || 'PHP' };
        setFormData(updatedData);
        setSubMode('manual');
        
        if (updatedData.amount && type === 'text') {
           setStatusMsg('âœ… è­˜åˆ¥æˆåŠŸ');
           setTimeout(() => autoSave(updatedData), 800);
        } else {
           setStatusMsg('âš ï¸ é‡‘é¡æœªè­˜åˆ¥ï¼Œè«‹æ‰‹å‹•ç¢ºèª');
        }
      }
    } catch (e) { 
      setStatusMsg('âŒ è­˜åˆ¥å¤±æ•—'); 
    } finally { 
      setLoading(false); 
    }
  };

  const autoSave = async (dataToSave) => {
    if (!dataToSave.amount) return;
    setSyncing(true);
    
    const saved = localStorage.getItem('expenses_v3_data');
    const currentList = saved ? JSON.parse(saved) : [];
    
    const record = { ...dataToSave, id: Date.now() };
    const newList = [record, ...currentList];
    
    setExpenses(newList);
    localStorage.setItem('expenses_v3_data', JSON.stringify(newList));
    
    try {
      await fetch(GAS_WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(record) });
    } catch (e) {
      console.error("Cloud save failed", e);
    } finally {
      setSyncing(false);
      setShowConfirmModal(true);
      setStatusMsg('');
    }
  };

  const syncCloudData = async () => {
    if (syncing) return;
    setSyncing(true);
    setStatusMsg('â˜ï¸ åŒæ­¥ä¸­...');
    try {
      const response = await fetch(GAS_WEB_APP_URL);
      const cloudData = await response.json();
      if (Array.isArray(cloudData)) {
        const saved = localStorage.getItem('expenses_v3_data');
        const localList = saved ? JSON.parse(saved) : [];
        const localIds = new Set(localList.map(e => String(e.id)));
        const newDataFromCloud = cloudData
          .filter(item => item.id && !localIds.has(String(item.id)))
          .map(item => ({ ...item, date: item.date ? item.date.split('T')[0] : getTodayStr() }));
        
        const combined = [...newDataFromCloud, ...localList].sort((a, b) => b.id - a.id);
        setExpenses(combined);
        localStorage.setItem('expenses_v3_data', JSON.stringify(combined));
        setStatusMsg('âœ… åŒæ­¥å®Œæˆ');
      }
    } catch (e) { 
      setStatusMsg('âŒ åŒæ­¥å¤±æ•—'); 
    } finally { 
      setSyncing(false); 
      setTimeout(() => setStatusMsg(''), 2000); 
    }
  };

  const toggleVoice = () => {
    if (isListening) {
        recognitionRef.current?.stop();
    } else {
        if (recognitionRef.current) {
            try { recognitionRef.current.start(); } catch (e) {}
        }
    }
  };

  const closeDrawer = () => {
    if (isListening) recognitionRef.current?.stop();
    setLoading(false);
    setShowDrawer(false);
    setSubMode('');
    setFormData(initialFormState);
    setStatusMsg('');
    setLastInputMode('manual'); 
  };

  const handleContinueNext = () => {
    // 1. æ¸…ç©ºè¡¨å–®ï¼Œä¿ç•™æ—¥æœŸ
    setFormData({ ...initialFormState, date: formData.date });
    setShowConfirmModal(false);
    
    // 2. æ ¹æ“šä¸Šä¸€æ¬¡çš„æ¨¡å¼è‡ªå‹•åŸ·è¡Œï¼Œå¯¦ç¾æµæš¢çºŒæ¥
    if (lastInputMode === 'voice') {
      setTimeout(() => toggleVoice(), 300);
    } else if (lastInputMode === 'camera') {
      setTimeout(() => fileInputRef.current?.click(), 300);
    }
  };

  const todayStats = useMemo(() => {
    const today = getTodayStr();
    const total = expenses.filter(ex => ex.date === today && ex.currency === 'PHP').reduce((s, c) => s + Number(c.amount || 0), 0);
    return { total };
  }, [expenses]);

  return (
    <div className="w-full min-h-[100dvh] bg-[#0f172a] text-slate-100 font-sans selection:bg-indigo-500/30 relative overflow-hidden">
      <div className="w-full min-h-[100dvh] flex flex-col bg-gradient-to-b from-[#1e293b] to-[#0f172a]">
        
        <header className="w-full px-6 pt-6 pb-2 flex justify-between items-center">
          <div>
            <h1 className="text-xl font-black tracking-tighter text-white uppercase italic">å¸¥å˜çš„å¸³å‹™è¨˜äº‹æœ¬</h1>
            <p className="text-[10px] font-bold text-indigo-400 tracking-[0.2em] uppercase opacity-70">Gemini Cloud v2.0 Final</p>
          </div>
          <button onClick={syncCloudData} className={`w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center text-slate-400 active:scale-95 ${syncing ? 'animate-spin text-indigo-400' : ''}`}>
            <RefreshCw className="w-4 h-4" />
          </button>
        </header>

        {statusMsg && (
          <div className="fixed top-24 left-0 right-0 z-[150] flex justify-center pointer-events-none">
            <div className={`flex items-center gap-3 px-6 py-3 rounded-full shadow-2xl text-xs font-black tracking-widest border border-white/20 animate-bounce pointer-events-auto transition-colors ${isListening ? 'bg-red-500' : 'bg-indigo-600'}`}>
              {isListening && <div className="w-2 h-2 bg-white rounded-full animate-ping" />}
              {statusMsg}
            </div>
          </div>
        )}

        <main className="flex-1 px-5 overflow-y-auto no-scrollbar pb-32">
          <div className="w-full space-y-8 mt-4">
            
            <div className="w-full bg-gradient-to-br from-indigo-500 to-purple-600 p-8 rounded-[3rem] shadow-2xl relative overflow-hidden">
              <div className="absolute top-0 right-0 w-48 h-48 bg-white/10 rounded-full -mr-24 -mt-24 blur-3xl"></div>
              <div className="flex justify-between items-start relative z-10 text-white/70 text-xs font-black uppercase tracking-[0.2em]">ä»Šæ—¥æ¶ˆè²»ç¸½è¨ˆ</div>
              <div className="flex items-baseline gap-2 mt-4 relative z-10">
                <span className="text-2xl font-bold opacity-60">PHP</span>
                <h2 className="text-5xl font-black tracking-tighter">{todayStats.total.toLocaleString()}</h2>
              </div>
              <div className="mt-6 flex items-center gap-2 relative z-10 opacity-80">
                <Sparkles className="w-3 h-3 text-yellow-300" />
                <span className="text-[10px] font-bold tracking-widest uppercase">AI è²¡å‹™åˆ†æå·²å°±ç·’</span>
              </div>
            </div>

            <div className="grid grid-cols-3 gap-3">
              <button onClick={() => { setSubMode('ai'); setLastInputMode('camera'); setShowDrawer(true); fileInputRef.current.click(); }} className="bg-slate-800/80 p-5 rounded-3xl border border-white/5 flex flex-col items-center gap-3 active:bg-emerald-600 transition-all">
                <div className="w-12 h-12 bg-emerald-500/20 rounded-2xl flex items-center justify-center text-emerald-400"><Camera className="w-6 h-6" /></div>
                <span className="text-[10px] font-black tracking-widest uppercase">AI æ‹ç…§</span>
              </button>
              <button onClick={() => { setSubMode('manual'); setLastInputMode('manual'); setShowDrawer(true); }} className="bg-slate-800/80 p-5 rounded-3xl border border-white/5 flex flex-col items-center gap-3 active:bg-slate-700 transition-all">
                <div className="w-12 h-12 bg-slate-700 rounded-2xl flex items-center justify-center text-slate-300"><Plus className="w-6 h-6" /></div>
                <span className="text-[10px] font-black tracking-widest uppercase">æ‰‹å‹•è¨˜å¸³</span>
              </button>
              <button onClick={() => { setSubMode('manual'); setLastInputMode('voice'); setShowDrawer(true); setTimeout(toggleVoice, 300); }} className={`p-5 rounded-3xl border border-white/5 flex flex-col items-center gap-3 transition-all ${isListening ? 'bg-red-600 animate-pulse' : 'bg-slate-800/80 active:bg-indigo-600'}`}>
                <div className={`w-12 h-12 rounded-2xl flex items-center justify-center ${isListening ? 'bg-white text-red-600' : 'bg-indigo-600/20 text-indigo-400'}`}>
                  {isListening ? <AudioLines className="w-6 h-6" /> : <Mic className="w-6 h-6" />}
                </div>
                <span className="text-[10px] font-black tracking-widest uppercase">{isListening ? 'æ­£åœ¨è½...' : 'èªéŸ³è­˜åˆ¥'}</span>
              </button>
            </div>

            <div className="space-y-4">
              <h3 className="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] flex items-center gap-2"><History className="w-3 h-3" /> æœ€è¿‘äº¤æ˜“ç´€éŒ„</h3>
              <div className="space-y-3">
                {expenses.length === 0 ? (
                  <div className="py-20 text-center opacity-20 italic text-xs uppercase tracking-widest">ç›®å‰å°šæœªæœ‰ä»»ä½•ç´€éŒ„</div>
                ) : (
                  expenses.slice(0, 15).map(ex => (
                    <div key={ex.id} className="bg-slate-800/40 p-5 rounded-[2rem] flex justify-between items-center border border-white/5 group">
                      <div className="flex gap-4 items-center">
                        <div className="w-11 h-11 bg-slate-900 rounded-2xl flex items-center justify-center text-xl shadow-inner">
                          {ex.category === 'é£Ÿç‰©' ? 'ğŸ±' : ex.category === 'äº¤é€š' ? 'ğŸš—' : 'ğŸ’µ'}
                        </div>
                        <div>
                          <p className="font-black text-sm text-slate-100 truncate max-w-[120px]">{ex.merchant || ex.category}</p>
                          <p className="text-[9px] text-slate-500 font-black uppercase mt-0.5">{ex.date} â€¢ {ex.category}</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="font-black text-red-400 text-lg">-{Number(ex.amount).toLocaleString()}</p>
                        <p className="text-[8px] font-bold text-slate-600">{ex.currency}</p>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        </main>

        <nav className="fixed bottom-0 left-0 right-0 z-[100] px-6 pb-8 pointer-events-none">
          <div className="w-full bg-slate-900/80 backdrop-blur-xl rounded-[2.5rem] px-8 py-4 flex justify-between items-center border border-white/5 pointer-events-auto shadow-2xl">
            <button onClick={() => setView('dashboard')} className={`p-2 transition-all ${view === 'dashboard' ? 'text-indigo-400 scale-110' : 'text-slate-500'}`}><Grid className="w-6 h-6" /></button>
            <button onClick={() => { setSubMode('manual'); setLastInputMode('manual'); setShowDrawer(true); }} className="w-14 h-14 bg-indigo-600 rounded-full flex items-center justify-center text-white shadow-lg -mt-12 border-4 border-[#0f172a] active:scale-90 transition-all"><Plus className="w-8 h-8" /></button>
            <button onClick={() => setView('report')} className={`p-2 transition-all ${view === 'report' ? 'text-indigo-400 scale-110' : 'text-slate-500'}`}><PieChart className="w-6 h-6" /></button>
          </div>
        </nav>

        {showDrawer && (
          <div className="fixed inset-0 z-[120] bg-slate-950/80 backdrop-blur-md flex items-end">
            <div className="w-full bg-slate-900 rounded-t-[3rem] border-t border-white/10 flex flex-col max-h-[92dvh] overflow-hidden">
              <div className="w-full flex justify-center py-4" onClick={closeDrawer}><div className="w-16 h-1.5 bg-slate-700 rounded-full"></div></div>
              
              <div className="px-8 pb-12 overflow-y-auto no-scrollbar relative">
                <div className="space-y-6 pt-2">
                  <div className="flex justify-between items-center mb-2">
                    <h2 className="text-lg font-black uppercase tracking-widest text-indigo-400">æ˜ç´°ç·¨è¼¯</h2>
                    <button onClick={closeDrawer} className="w-10 h-10 bg-slate-800 rounded-full flex items-center justify-center text-slate-400"><X className="w-5 h-5" /></button>
                  </div>

                  <div className="space-y-6">
                    <div className={`space-y-3 border-b-2 pb-4 transition-colors ${isListening ? 'border-red-500 animate-pulse' : 'border-indigo-500/30'}`}>
                      <label className="text-[10px] font-black text-slate-500 uppercase px-1 tracking-widest flex justify-between items-center">
                        é‡‘é¡èˆ‡å¹£ç¨® {isListening && <span className="text-red-500 flex items-center gap-1 animate-bounce">æ­£åœ¨éŒ„éŸ³ <Waves className="w-3 h-3" /></span>}
                      </label>
                      <div className="flex items-center gap-4">
                        <input 
                          type="number" 
                          inputMode="decimal" 
                          value={formData.amount} 
                          onChange={e => setFormData({...formData, amount: e.target.value})} 
                          className={`flex-1 bg-transparent text-6xl font-black outline-none tracking-tighter transition-colors ${isListening ? 'text-red-400' : 'text-white'}`} 
                          placeholder="0" 
                        />
                        <select 
                          value={formData.currency} 
                          onChange={e => setFormData({...formData, currency: e.target.value})}
                          className="bg-indigo-600 text-white font-black text-xs px-3 py-2 rounded-xl border-none outline-none shadow-lg"
                        >
                          {CURRENCIES.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                      <div className="space-y-1">
                        <label className="text-[10px] font-black text-slate-500 uppercase px-1 tracking-widest">åˆ†é¡</label>
                        <select value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})} className="w-full bg-slate-800 p-4 rounded-2xl text-sm font-bold border border-white/5 outline-none">{CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</select>
                      </div>
                      <div className="space-y-1">
                        <label className="text-[10px] font-black text-slate-500 uppercase px-1 tracking-widest">æ—¥æœŸ</label>
                        <input type="date" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className="w-full bg-slate-800 p-4 rounded-2xl text-sm font-bold border border-white/5 outline-none" />
                      </div>
                    </div>

                    <div className="space-y-1">
                      <label className="text-[10px] font-black text-slate-500 uppercase px-1 tracking-widest">å•†å®¶è³‡è¨Š</label>
                      <input type="text" value={formData.merchant} onChange={e => setFormData({...formData, merchant: e.target.value})} className="w-full bg-slate-800 p-4 rounded-2xl text-sm font-bold text-white border border-white/5 outline-none" placeholder="åº—å®¶åç¨±" />
                      <textarea value={formData.details} onChange={e => setFormData({...formData, details: e.target.value})} className="w-full bg-slate-800 p-4 mt-2 rounded-2xl text-sm font-medium text-slate-400 border border-white/5 outline-none h-20 resize-none" placeholder="é …ç›®æ˜ç´°..." />
                    </div>

                    <div className="flex gap-4 pt-4">
                      <button onClick={toggleVoice} className={`w-16 h-16 rounded-2xl flex items-center justify-center transition-all ${isListening ? 'bg-red-600 text-white scale-110 shadow-red-500/50 shadow-xl' : 'bg-slate-800 text-indigo-400'}`}>
                        {isListening ? <AudioLines className="w-6 h-6" /> : <Mic className="w-6 h-6" />}
                      </button>
                      <button onClick={() => autoSave(formData)} disabled={!formData.amount || syncing || loading} className="flex-1 bg-indigo-600 rounded-2xl font-black flex items-center justify-center gap-3 text-white shadow-xl active:scale-95 transition-all disabled:opacity-50">
                        {syncing || loading ? <Loader2 className="animate-spin w-5 h-5" /> : <Save className="w-5 h-5" />}
                        å„²å­˜ç´€éŒ„
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {showConfirmModal && (
          <div className="fixed inset-0 z-[200] bg-slate-950/90 backdrop-blur-3xl flex items-center justify-center p-8">
            <div className="bg-slate-800 w-full max-w-xs rounded-[3rem] p-8 border border-white/10 text-center space-y-6 animate-in zoom-in-95">
              <div className="w-20 h-20 bg-emerald-500/20 text-emerald-500 rounded-full flex items-center justify-center mx-auto"><CheckCircle2 className="w-10 h-10" /></div>
              <div className="space-y-2">
                <h3 className="text-2xl font-black text-white uppercase italic tracking-tighter">Success</h3>
                <p className="text-slate-400 text-[10px] font-bold tracking-widest uppercase">ç´€éŒ„å·²åŒæ­¥è‡³é›²ç«¯</p>
              </div>
              <div className="flex flex-col gap-3">
                <button onClick={handleContinueNext} className="w-full py-5 bg-white text-slate-900 rounded-2xl font-black text-sm shadow-xl tracking-widest flex items-center justify-center gap-2 active:scale-95 transition-all"><PlusCircle className="w-4 h-4" /> ç¹¼çºŒä¸‹ä¸€ç­†</button>
                <button onClick={() => { setShowConfirmModal(false); closeDrawer(); }} className="w-full py-4 bg-slate-700/50 text-slate-300 rounded-2xl font-black text-xs shadow-xl tracking-widest active:scale-95 transition-all">å›åˆ°é¦–é </button>
              </div>
            </div>
          </div>
        )}

        <input type="file" ref={fileInputRef} className="hidden" accept="image/*" capture="environment" onChange={(e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onloadend = () => callGeminiAI({ mimeType: file.type, base64: reader.result.split(',')[1] }, 'image');
            reader.readAsDataURL(file);
          }
        }} />
      </div>
    </div>
  );
};

export default App;
