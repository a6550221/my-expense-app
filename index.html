<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â∏•ÂòéÁöÑÂ∏≥ÂãôË®ò‰∫ãÊú¨ V2.0</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #0f172a; color: white; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type="date"]::-webkit-inner-spin-button,
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- ÂàùÂßãËÆÄÂèñÁãÄÊÖãÔºåÈò≤Ê≠¢ÈªëÂ±è -->
        <div style="display: flex; height: 100vh; align-items: center; justify-content: center; font-family: sans-serif;">
            <div style="text-align: center;">
                <div style="width: 40px; height: 40px; border: 4px solid #312e81; border-top: 4px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <p style="color: #94a3b8; font-size: 14px;">Á≥ªÁµ±ÂïüÂãï‰∏≠...</p>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        // Lucide ÂúñÁ§∫ÁµÑ‰ª∂ÔºàÂ¢ûÂä†Èò≤ÈåØËôïÁêÜÔºâ
        const Icon = ({ name, className }) => {
            const [svg, setSvg] = useState('');
            useEffect(() => {
                const timer = setInterval(() => {
                    if (window.lucide && window.lucide.icons[name]) {
                        const icon = window.lucide.icons[name];
                        const svgString = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">${icon[1].map(i => `<${i[0]} ${Object.entries(i[1]).map(([k,v]) => `${k}="${v}"`).join(' ')} />`).join('')}</svg>`;
                        setSvg(svgString);
                        clearInterval(timer);
                    }
                }, 100);
                return () => clearInterval(timer);
            }, [name, className]);
            return <div dangerouslySetInnerHTML={{ __html: svg }} />;
        };

        const CATEGORIES = ['È£üÁâ©', 'ÁîüÊ¥ª', 'Â®õÊ®Ç', '‰∫§ÈÄö', 'ÈÜ´ÁôÇ', 'ÊïôËÇ≤', 'ÂÖ∂‰ªñ'];
        const CURRENCIES = ['PHP', 'TWD', 'USD', 'HKD', 'JPY'];
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyPmJnep8GKhqIpwkJgokekQpirRJFZRB-PRXD9QZVpx786tEVDxCOYi4bb7gsj5lyL/exec";

        const App = () => {
            const [expenses, setExpenses] = useState([]);
            const [loading, setLoading] = useState(false);
            const [syncing, setSyncing] = useState(false);
            const [showDrawer, setShowDrawer] = useState(false);
            const [lastInputMode, setLastInputMode] = useState('manual');
            const [isListening, setIsListening] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            
            const recognitionRef = useRef(null);
            const fileInputRef = useRef(null);
            
            // ÈáçË¶ÅÔºöË´ãÂãôÂøÖÂ°´ÂØ´ÊÇ®ÁöÑ Gemini API Key
            const apiKey = ""; 

            const getTodayStr = () => new Date().toLocaleDateString('en-CA');
            const initialFormState = { date: getTodayStr(), amount: '', category: 'È£üÁâ©', merchant: '', details: '', currency: 'PHP' };
            const [formData, setFormData] = useState(initialFormState);

            useEffect(() => {
                try {
                    const saved = localStorage.getItem('expenses_v3_data');
                    if (saved) setExpenses(JSON.parse(saved));
                } catch (e) { console.error("LocalStorage error", e); }
                initSpeech();
            }, []);

            const initSpeech = () => {
                const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (Rec) {
                    const r = new Rec();
                    r.lang = 'zh-TW';
                    r.onstart = () => { setIsListening(true); setStatusMsg('üé§ Ê≠£Âú®ËÅÜËÅΩ...'); };
                    r.onend = () => { setIsListening(false); };
                    r.onresult = (e) => callGeminiAI(e.results[0][0].transcript, 'text');
                    recognitionRef.current = r;
                }
            };

            const callGeminiAI = async (input, type) => {
                if (!apiKey) {
                    setStatusMsg('‚ùå ÈåØË™§ÔºöÂ∞öÊú™Ë®≠ÂÆö API Key');
                    return;
                }
                setLoading(true);
                setStatusMsg('ü§ñ AI Êô∫ËÉΩË≠òÂà•‰∏≠...');
                try {
                    const prompt = `‰Ω†ÊòØ‰∏ÄÂÄãË®òÂ∏≥Âä©Êâã„ÄÇ‰ªäÂ§©ÊòØ ${getTodayStr()}„ÄÇË´ãÂ∞áËº∏ÂÖ•ÊèêÂèñÁÇ∫ JSON: {"amount":Êï∏Â≠ó, "merchant":"ÂïÜÂÆ∂", "category":"È£üÁâ©/ÁîüÊ¥ª/Â®õÊ®Ç/‰∫§ÈÄö/ÈÜ´ÁôÇ/ÊïôËÇ≤/ÂÖ∂‰ªñ", "details":"Ë™™Êòé", "date":"YYYY-MM-DD", "currency":"PHP"}`;
                    const body = type === 'text' 
                        ? { contents: [{ parts: [{ text: `${prompt}\n\nÂÖßÂÆπ: ${input}` }] }] }
                        : { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: input.mimeType, data: input.base64 } }] }] };

                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    
                    if (!res.ok) throw new Error('API Ë´ãÊ±ÇÂ§±Êïó');
                    
                    const data = await res.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    const jsonMatch = text.match(/\{.*\}/s);
                    if (jsonMatch) {
                        const parsed = JSON.parse(jsonMatch[0]);
                        const updated = { ...formData, ...parsed };
                        setFormData(updated);
                        if (updated.amount && type === 'text') autoSave(updated);
                        else setStatusMsg('‚ö†Ô∏è Ë´ãÊâãÂãïÁ¢∫Ë™çÈáëÈ°ç');
                    }
                } catch (e) { 
                    console.error(e);
                    setStatusMsg('‚ùå Ë≠òÂà•Â§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÊàñ API Key'); 
                } finally { setLoading(false); }
            };

            const autoSave = async (data) => {
                setSyncing(true);
                const record = { ...data, id: Date.now() };
                const newList = [record, ...expenses];
                setExpenses(newList);
                localStorage.setItem('expenses_v3_data', JSON.stringify(newList));
                try {
                    await fetch(GAS_WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(record) });
                    setShowConfirmModal(true);
                } catch (e) {
                    console.error("GAS sync error", e);
                } finally { setSyncing(false); setStatusMsg(''); }
            };

            const handleContinue = () => {
                setFormData({ ...initialFormState, date: formData.date });
                setShowConfirmModal(false);
                if (lastInputMode === 'voice') recognitionRef.current?.start();
                else if (lastInputMode === 'camera') fileInputRef.current?.click();
            };

            const todayTotal = useMemo(() => {
                const today = getTodayStr();
                return expenses
                    .filter(e => e.date === today && e.currency === 'PHP')
                    .reduce((a, b) => a + Number(b.amount || 0), 0);
            }, [expenses]);

            return (
                <div className="min-h-screen bg-[#0f172a] text-white flex flex-col overflow-hidden">
                    {/* Header */}
                    <header className="p-6 flex justify-between items-center shrink-0">
                        <div>
                            <h1 className="text-xl font-black italic tracking-tighter uppercase">Â∏•ÂòéÁöÑÂ∏≥ÂãôË®ò‰∫ãÊú¨</h1>
                            <p className="text-[10px] font-bold text-indigo-400 tracking-widest opacity-70">V2.0 OFFICIAL FINAL</p>
                        </div>
                        <button onClick={() => window.location.reload()} className="w-10 h-10 bg-slate-800 rounded-xl flex items-center justify-center text-slate-400">
                            <Icon name="RefreshCw" className="w-4 h-4" />
                        </button>
                    </header>

                    {/* Status Bar */}
                    {statusMsg && (
                        <div className="fixed top-24 inset-x-0 z-[100] flex justify-center px-6">
                            <div className="bg-indigo-600 px-6 py-3 rounded-full shadow-2xl text-xs font-black animate-bounce flex items-center gap-2">
                                {isListening && <span className="w-2 h-2 bg-white rounded-full animate-ping" />}
                                {statusMsg}
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <main className="flex-1 px-5 space-y-8 overflow-y-auto no-scrollbar pb-32">
                        <div className="bg-gradient-to-br from-indigo-500 to-purple-600 p-8 rounded-[3rem] shadow-2xl mt-4">
                            <div className="text-[10px] font-black uppercase tracking-widest opacity-70">‰ªäÊó•Á∏ΩÊîØÂá∫ (PHP)</div>
                            <div className="text-5xl font-black mt-2 tracking-tighter">
                                {loading ? '...' : todayTotal.toLocaleString()}
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-3">
                            <button onClick={() => { setLastInputMode('camera'); setShowDrawer(true); fileInputRef.current.click(); }} className="bg-slate-800/80 p-5 rounded-3xl flex flex-col items-center gap-3 active:scale-95 transition-transform active:bg-emerald-600">
                                <Icon name="Camera" className="text-emerald-400 w-6 h-6" />
                                <span className="text-[10px] font-black">AI ÊãçÁÖß</span>
                            </button>
                            <button onClick={() => { setLastInputMode('manual'); setShowDrawer(true); }} className="bg-slate-800/80 p-5 rounded-3xl flex flex-col items-center gap-3 active:scale-95 transition-transform">
                                <Icon name="Plus" className="text-slate-300 w-6 h-6" />
                                <span className="text-[10px] font-black">ÊâãÂãï</span>
                            </button>
                            <button onClick={() => { setLastInputMode('voice'); setShowDrawer(true); recognitionRef.current?.start(); }} className={`p-5 rounded-3xl flex flex-col items-center gap-3 active:scale-95 transition-transform ${isListening ? 'bg-red-600 animate-pulse' : 'bg-slate-800'}`}>
                                <Icon name="Mic" className="text-indigo-400 w-6 h-6" />
                                <span className="text-[10px] font-black">Ë™ûÈü≥</span>
                            </button>
                        </div>

                        <div className="space-y-4">
                            <h3 className="text-[10px] font-black text-slate-500 uppercase tracking-widest">ÊúÄËøëÁ¥ÄÈåÑ</h3>
                            {expenses.length === 0 ? (
                                <div className="text-center py-10 opacity-30 text-xs font-bold uppercase tracking-widest">Â∞öÁÑ°Ë≥áÊñô</div>
                            ) : (
                                expenses.slice(0, 10).map(ex => (
                                    <div key={ex.id} className="bg-slate-800/40 p-5 rounded-3xl border border-white/5 flex justify-between items-center">
                                        <div className="flex gap-4 items-center">
                                            <div className="text-2xl">{ex.category === 'È£üÁâ©' ? 'üç±' : 'üíµ'}</div>
                                            <div>
                                                <p className="font-black text-sm">{ex.merchant || ex.category}</p>
                                                <p className="text-[9px] text-slate-500 font-bold uppercase">{ex.date}</p>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <p className="font-black text-red-400">-{Number(ex.amount).toLocaleString()}</p>
                                            <p className="text-[8px] font-bold opacity-40">{ex.currency}</p>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </main>

                    {/* Footer Nav */}
                    <nav className="fixed bottom-0 inset-x-0 p-6 z-50">
                        <div className="bg-slate-900/90 backdrop-blur-xl rounded-[2.5rem] p-4 flex justify-around items-center border border-white/5 shadow-2xl">
                            <Icon name="Grid" className="text-indigo-400 w-6 h-6" />
                            <button onClick={() => setShowDrawer(true)} className="w-14 h-14 bg-indigo-600 rounded-full flex items-center justify-center -mt-12 border-4 border-[#0f172a] shadow-xl active:scale-90 transition-transform">
                                <Icon name="Plus" className="text-white w-8 h-8" />
                            </button>
                            <Icon name="PieChart" className="text-slate-600 w-6 h-6" />
                        </div>
                    </nav>

                    {/* Edit Drawer */}
                    {showDrawer && (
                        <div className="fixed inset-0 z-[120] bg-black/80 backdrop-blur-sm flex items-end">
                            <div className="w-full bg-slate-900 rounded-t-[3rem] p-8 pb-12 animate-in slide-in-from-bottom duration-300">
                                <div className="flex justify-between items-center mb-8">
                                    <h2 className="font-black uppercase tracking-widest text-indigo-400">Á∑®ËºØÊîØÂá∫</h2>
                                    <button onClick={() => {setShowDrawer(false); setIsListening(false);}} className="text-slate-500 active:rotate-90 transition-transform"><Icon name="X" className="w-6 h-6" /></button>
                                </div>
                                <div className="space-y-6">
                                    <div className="border-b border-indigo-500/30 pb-4">
                                        <div className="flex items-center gap-4">
                                            <input type="number" inputMode="decimal" value={formData.amount} onChange={e=>setFormData({...formData, amount: e.target.value})} className="flex-1 bg-transparent text-6xl font-black outline-none tracking-tighter" placeholder="0" />
                                            <select value={formData.currency} onChange={e=>setFormData({...formData, currency: e.target.value})} className="bg-indigo-600 p-2 rounded-xl text-xs font-black uppercase outline-none">{CURRENCIES.map(c=><option key={c} value={c}>{c}</option>)}</select>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <select value={formData.category} onChange={e=>setFormData({...formData, category: e.target.value})} className="bg-slate-800 p-4 rounded-2xl text-sm font-bold border border-white/5 outline-none">{CATEGORIES.map(c=><option key={c} value={c}>{c}</option>)}</select>
                                        <input type="date" value={formData.date} onChange={e=>setFormData({...formData, date: e.target.value})} className="bg-slate-800 p-4 rounded-2xl text-sm font-bold border border-white/5 outline-none" />
                                    </div>
                                    <input type="text" value={formData.merchant} onChange={e=>setFormData({...formData, merchant: e.target.value})} className="w-full bg-slate-800 p-4 rounded-2xl text-sm font-bold border border-white/5 outline-none" placeholder="ÂïÜÂÆ∂ÂêçÁ®± / ÂÇôË®ª" />
                                    <div className="flex gap-4">
                                        <button onClick={() => recognitionRef.current?.start()} className={`w-16 h-16 rounded-2xl flex items-center justify-center active:scale-95 transition-transform ${isListening ? 'bg-red-600 animate-pulse' : 'bg-slate-800'}`}><Icon name="Mic" className="w-6 h-6" /></button>
                                        <button onClick={() => autoSave(formData)} disabled={!formData.amount || syncing || loading} className="flex-1 bg-indigo-600 rounded-2xl font-black shadow-xl active:scale-95 transition-transform disabled:opacity-50 flex items-center justify-center gap-2">
                                            {(syncing || loading) && <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>}
                                            {syncing ? 'ÂêåÊ≠•‰∏≠...' : 'ÂÑ≤Â≠òÁ¥ÄÈåÑ'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Success Modal */}
                    {showConfirmModal && (
                        <div className="fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-8 backdrop-blur-md">
                            <div className="bg-slate-800 w-full max-w-xs rounded-[3rem] p-8 text-center space-y-6 border border-white/10 shadow-2xl animate-in zoom-in duration-200">
                                <div className="w-20 h-20 bg-emerald-500/20 text-emerald-500 rounded-full flex items-center justify-center mx-auto"><Icon name="CheckCircle" className="w-10 h-10" /></div>
                                <h3 className="text-2xl font-black italic tracking-tighter">SUCCESS</h3>
                                <button onClick={handleContinue} className="w-full py-5 bg-white text-slate-900 rounded-2xl font-black text-sm tracking-widest active:scale-95 transition-transform">ÁπºÁ∫å‰∏ã‰∏ÄÁ≠Ü</button>
                                <button onClick={() => {setShowConfirmModal(false); setShowDrawer(false);}} className="w-full py-4 text-slate-500 text-xs font-bold uppercase tracking-widest">ÂõûÂà∞È¶ñÈ†Å</button>
                            </div>
                        </div>
                    )}

                    {/* Hidden Camera Input */}
                    <input type="file" ref={fileInputRef} className="hidden" accept="image/*" capture="environment" onChange={(e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const r = new FileReader();
                            r.onloadend = () => callGeminiAI({ mimeType: file.type, base64: r.result.split(',')[1] }, 'image');
                            r.readAsDataURL(file);
                        }
                    }} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
